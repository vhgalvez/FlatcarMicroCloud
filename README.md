# FlatcarMicroCloud: Entorno Kubernetes Optimizado para Servidores F√≠sicos

## Descripci√≥n General del Proyecto

**FlatcarMicroCloud** es una soluci√≥n Kubernetes dise√±ada para maximizar los recursos de un servidor f√≠sico. El entorno se ejecuta sobre un servidor **ProLiant DL380 G7**, utilizando **Rocky Linux 9.5** como sistema operativo base para virtualizaci√≥n, junto con **AlmaLinux 9.4** en algunos nodos auxiliares. Las m√°quinas virtuales que componen el cl√∫ster Kubernetes utilizan **Flatcar Container Linux** como sistema operativo liviano y seguro.

Esta arquitectura permite desplegar aplicaciones en contenedores mediante herramientas modernas como:

- **K3s**, una distribuci√≥n ligera de Kubernetes.
- **Longhorn y NFS** para almacenamiento persistente.
- **Prometheus y Grafana** para monitoreo y visualizaci√≥n avanzada.
- **Apache redpanda y MQTT Mosquitto** para comunicaci√≥n asincr√≥nica entre microservicios.

## Hardware del Servidor

![ProLiant DL380 G7](additional_resources/image/hp_server.png)

- **Modelo**: ProLiant DL380 G7
- **CPU**: Intel Xeon X5650 (24 cores) @ 2.666GHz
- **GPU**: AMD ATI ES1000
- **Memoria Total**: 35 GB RAM
- **Almacenamiento**:
  - Disco Principal: 1.5TB
  - Disco Secundario: 3.0TB

## Sistemas Operativos y Virtualizaci√≥n

- **Sistemas Operativos**: Rocky Linux 9.5 y Flatcar Container Linux y Alma Linux 9.4
- **Virtualizaci√≥n**: KVM con Libvirt y Virt-Manager y oVirt
- **Configuraci√≥n de Red**: VPN con WireGuard, DHCP, firewall, y configuraciones de redes virtuales (NAT y Bridge) con KVM.
- **Switch y Router**: Facilitan la comunicaci√≥n y conectividad del cl√∫ster.

## Resumen de Recursos para M√°quinas Virtuales

| **Hostname**    | **IP**        | **Dominio**                  | **CPU** | **Memoria (MB)** | **Disco (GB)** |
|-----------------|---------------|-----------------------------|---------|------------------|----------------|
| master1         | 10.17.4.21    | master1.cefaslocalserver.com | 2       | 4096             | 50             |
| master2         | 10.17.4.22    | master2.cefaslocalserver.com | 2       | 4096             | 50             |
| master3         | 10.17.4.23    | master3.cefaslocalserver.com | 2       | 4096             | 50             |
| worker1         | 10.17.4.24    | worker1.cefaslocalserver.com | 2       | 4096             | 50             |
| worker2         | 10.17.4.25    | worker2.cefaslocalserver.com | 2       | 4096             | 50             |
| worker3         | 10.17.4.26    | worker3.cefaslocalserver.com | 2       | 4096             | 50             |
| storage1        | 10.17.3.27    | storage1.cefaslocalserver.com| 2       | 2048             | 80             |
| infra-cluster   | 10.17.3.11    | infra-cluster.cefaslocalserver.com| 2   | 2048             | 32             |
| loadbalancer1   | 10.17.3.12    | loadbalancer1.cefaslocalserver.com | 2   | 2048             | 32             |
| loadbalancer2   | 10.17.3.13    | loadbalancer2.cefaslocalserver.com | 2   | 2048             | 32             |
| postgresql1     | 10.17.3.14    | postgresql1.cefaslocalserver.com | 2     | 2048             | 32             |
| k8s-api-lb      | 10.17.5.10    | k8s-api-lb.cefaslocalserver.com | 2     | 2048             | 80             |

## M√°quinas Virtuales y Roles

| Nodo               | Sistema Operativo       | Funci√≥n                                    | Cantidad |
| ------------------ | ----------------------- | ------------------------------------------ | -------- |
| k8s-api-lb         | Alma Linux              | gestion y seguridad                        | 1        |
| Load Balancer Node | Alma Linux              | Balanceo Traefik controlador de ingress    | 2        |
| infra-cluster Node | Alma Linux              | DNS coredns / ntp  Chrony                  | 1        |
| PostgreSQL Node    | Alma Linux              | Base de datos central para microservicios  | 1        |
| Master Node        | Flatcar Container Linux | Administraci√≥n de API de Kubernetes        | 3        |
| Worker Nodes       | Flatcar Container Linux | Ejecuci√≥n de microservicios y aplicaciones | 3        |
| storage1           | Alma Linux              | almacenacenamiento                         | 1        |

## Explicaci√≥n de Roles de las VMs

- **Maestros (master1, master2, master3)**:
  - Nodos que conforman el plano de control de Kubernetes, manejando la API y distribuyendo la carga en los nodos worker.

- **Workers (worker1, worker2, worker3)**:
  - Nodos que ejecutan aplicaciones y microservicios, proporcionando la capacidad de escalar horizontalmente.

- **infra-cluster (infra-cluster)**:
  - Nodo que act√∫a como servidor DNS coredns y ntp  Chrony

- **Load Balancer (load_balancer1,load_balancer2)**:
  - Nodos que distribuyen el tr√°fico de red entre los nodos maestros y workers, asegurando un balanceo de carga eficiente.

- **PostgreSQL (postgresql1)**:
  - Nodo dedicado para la base de datos, proporcionando almacenamiento persistente para las aplicaciones de microservicios.

## Fases de Implementaci√≥n

### Fase 1: Instalaci√≥n y Configuraci√≥n de K3s en el Cl√∫ster de Kubernetes

1. **Nodo Master1**: Instalaci√≥n de K3s y configuraci√≥n inicial del cl√∫ster.
2. **Nodos Master y Worker**: Configuraci√≥n de nodos maestros y workers, desplegando Traefik como balanceador.

### Fase 2: Configuraci√≥n de PostgreSQL

| Aspecto                 | Configuraci√≥n                                                            |
| ----------------------- | ------------------------------------------------------------------------ |
| Servidor                | `postgresql1.cefaslocalserver.com`                                       |
| Permisos                | Ajusta permisos para permitir el acceso de microservicios en el cl√∫ster. |
| Respaldo y Recuperaci√≥n | Define pol√≠ticas para almacenamiento y recuperaci√≥n de datos.            |

### Fase 3: Desarrollo e Implementaci√≥n de Microservicios

- **Apache Kafka**: Canal de comunicaci√≥n as√≠ncrona entre microservicios.
- **MQTT Mosquitto**: Protocolo ligero para notificaciones en tiempo real.
- **Redis**: Base de datos en memoria para almacenamiento en cach√© y escalabilidad.

### Fase 4: Desarrollo del Frontend con Vue.js

- **Vue.js** para la interfaz de usuario, conectada a APIs de FastAPI. Desplegado en el cl√∫ster con acceso a trav√©s del balanceador Traefik.

## Automatizaci√≥n y Orquestaci√≥n

- **Terraform**: Automatizaci√≥n de infraestructura.
- **Ansible**: Configuraci√≥n y manejo de operaciones.

## Pasos para la Implementaci√≥n

### Paso 1: Preparativos Iniciales

Clonar el repositorio en el servidor Rocky Linux.

#### Estructura del Proyecto

- `nat_network_01/`
- `nat_network_02/`
- `nat_network_03/`

#### Requisitos

- [Terraform](https://www.terraform.io/downloads.html) v0.13 o superior
- Acceso a un servidor KVM con libvirt

## Red y Conectividad

```bash
# Clonar repositorio
git clone https://github.com/vhgalvez/FlatcarMicroCloud.git
cd FlatcarMicroCloud
```

### Paso 2: Configuraci√≥n de Redes Virtuales con Terraform

- **Red nat_network_02**:

  ```bash
  # Navegar a nat_network_01
  cd nat_network_01
  # Inicializar y aplicar Terraform
  sudo terraform init --upgrade
  sudo terraform apply
  ```

- **Red nat_network_02**:

  ```bash
  # Navegar a nat_network_02
  cd ../nat_network_02
  # Inicializar y aplicar Terraform
  sudo terraform init --upgrade
  sudo terraform apply
  ```

- **Red nat_network_03**:

  ```bash
  # Navegar a nat_network_03
  cd ../nat_network_03
  # Inicializar y aplicar Terraform
  sudo terraform init --upgrade
  sudo terraform apply
  ```

---

### Componentes

- **Prometheus**: Servidor de m√©tricas.
- **Grafana**: Visualizaci√≥n de dashboards.
- **Node Exporter**: M√©tricas del sistema operativo.
- **PushGateway**: Recepci√≥n de m√©tricas push.
- **Scrape Externo**: Monitorizaci√≥n de m√°quinas fuera del cl√∫ster.

---

## ‚úÖ **Infraestructura Lista**

Al finalizar todos los pasos, tu entorno Kubernetes con alta disponibilidad estar√° completamente configurado y operativo, con los siguientes componentes:

- **DNS**
- **Balanceo de carga** con HAProxy + Keepalived (VIP)
- **Cl√∫ster Kubernetes** con K3s en alta disponibilidad (etcd)
- **Ingress Controller** con certificados TLS usando Traefik
- **Almacenamiento persistente** con NFS y Longhorn listo para usarse

---

### ‚ú® **Desarrollado para la soluci√≥n FlatcarMicroCloud**

Este flujo de trabajo est√° optimizado para ser desplegado sobre **servidores f√≠sicos o virtualizados**, garantizando una soluci√≥n robusta y escalable.

---

### üîÑ **Advertencias:**

- **Seguridad:** Aseg√∫rate de que todos los certificados y claves privadas est√©n correctamente protegidos.
- **Escalabilidad:** Este enfoque permite que tu infraestructura escale f√°cilmente agregando m√°s nodos al cl√∫ster y configurando balanceadores de carga adicionales si es necesario.
- **Mantenimiento:** Mant√©n siempre actualizado tu cl√∫ster Kubernetes y los componentes relacionados, incluyendo el Ingress Controller y el almacenamiento.

Este proceso de automatizaci√≥n con Ansible te ayudar√° a gestionar y mantener tu infraestructura Kubernetes de manera eficiente y segura.

## Maquinas Virtuales Monitoreo y Gesti√≥n de Recursos

![kvm_virt-top](additional_resources/image/kvm_virt-top.png)

---

## Notas Adicionales

- Aseg√∫rese de tener las variables y configuraciones adecuadas en los archivos `terraform.tfvars` de cada subproyecto.
- Cada subproyecto tiene su propio `main.tf` y configuraci√≥n de variables, por lo que no deber√≠a haber conflictos de nombres si sigue las instrucciones anteriores.
- Puede ajustar las configuraciones y variables seg√∫n sea necesario para adaptarse a su entorno y necesidades espec√≠ficas.

### Paso 3: Instalaci√≥n de VMs y Sistemas Operativos

Provisionar y configurar VMs seg√∫n especificaciones en la tabla de recursos, asegurando la asignaci√≥n de CPU, RAM, y almacenamiento.


### Paso 5: Configuraci√≥n de Almacenamiento Persistente

Instalar y configurar Longhorn y NFS en el cl√∫ster de Kubernetes para almacenamiento persistente.

### Paso 6: Configuraci√≥n de Monitoreo y Visualizaci√≥n

- Configurar **Prometheus** y **Grafana** para monitoreo.
- Configurar **ELK Stack** para an√°lisis de logs y visualizaci√≥n de datos.

### Paso 7: Configuraci√≥n de CI/CD y Automatizaci√≥n

Configurar Jenkins y/o GitHub Actions para la integraci√≥n continua (CI), ejecutando pruebas autom√°ticas, an√°lisis de c√≥digo y construcci√≥n de im√°genes de contenedor.

Configurar un Docker Registry (privado o p√∫blico) para almacenar y versionar im√°genes generadas por el proceso de CI.

Configurar ArgoCD como herramienta de despliegue continuo (CD), conectando los cambios en el repositorio con el entorno de Kubernetes mediante una estrategia GitOps.

### Paso 8: Configuraci√≥n de Seguridad

Configurar reglas de **firewall**, **Fail2Ban** y pol√≠ticas de seguridad.

### Paso 9: Sincronizaci√≥n y NTP

Configurar **chronyc** en todos los nodos para sincronizaci√≥n temporal.

### Paso 10: Pruebas Finales y Puesta en Producci√≥n

- Verificar configuraci√≥n de red y DNS.
- Probar despliegue de aplicaciones y monitorizaci√≥n de m√©tricas.
- Asegurar que el balanceador de carga y servicios en Kubernetes est√©n operativos.

Este flujo garantiza que todas las dependencias y configuraciones sean instaladas en el orden correcto y optimizadas para un entorno de producci√≥n.

## Microservicios en Pods

#### Microservicios de Servicios de Aplicaciones

- **Nginx**: Servidor web aplicaciones web.
- **Redis**: Almacenamiento en cach√© y base de datos en memoria para mejorar el rendimiento de las aplicaciones.
- ** **: Plataforma de mensajer√≠a utilizada para la comunicaci√≥n entre microservicios.

#### An√°lisis y Visualizaci√≥n de Datos

- **Prometheus**: Herramientas para el monitoreo, alertas **alertmanager** y visualizaci√≥n de m√©tricas.
- **Grafana**: Visualizaci√≥n de m√©tricas del cl√∫ster.
- **Nagios**: Rendimiento del sistema.
- **cAdvisor**: Monitorear el rendimiento y uso de recursos por parte de los contenedores.
- **ELK Stack Elasticsearch**: Visualizaci√≥n de m√©tricas del cl√∫ster.
- **ELK Stack Kibana**: Visualizaci√≥n de datos.
- **ELK Stack Logstash**: Procesamiento de logs.

## Seguridad y Protecci√≥n

- **Firewall nftables**: Configuraci√≥n de reglas de firewall para proteger el cl√∫ster.
- **Fail2Ban**: Protecci√≥n contra accesos no autorizados y ataques.

## Almacenamiento Persistente

- **Longhorn**: Orquestar Longhorn en Kubernetes para almacenamiento persistente.
- **NFS**: Configurar NFS para almacenamiento compartido entre nodos para base de datos postgresql.

## Seguridad y Monitoreo

- **Prometheus y Grafana**: Monitoreo avanzado y visualizaci√≥n de m√©tricas.
- **Longhorn y NFS**: Almacenamiento persistente en Kubernetes.
- **Firewall y Fail2Ban**: Seguridad del entorno.

## Redes Virtuales y Arquitectura de Red

### Redes Virtuales Configuradas

| Red NAT         | Nodos         | Direcci√≥n IP | Rol del Nodo                             |
| --------------- | ------------- | ------------ | ---------------------------------------- |
| kube_network_02 | infra-cluster | 10.17.3.11   | Servidor de DNS y gesti√≥n de identidades |
| kube_network_02 | loadbalancer1 | 10.17.3.12   | Balanceo de carga para el cl√∫ster        |
| kube_network_02 | loadbalancer2 | 10.17.3.13   | Balanceo de carga para el cl√∫ster        |
| kube_network_02 | postgresql1   | 10.17.3.14   | Gesti√≥n de bases de datos                |
| kube_network_03 | master1       | 10.17.4.21   | Gesti√≥n del cl√∫ster                      |
| kube_network_03 | master2       | 10.17.4.22   | Gesti√≥n del cl√∫ster                      |
| kube_network_03 | master3       | 10.17.4.23   | Gesti√≥n del cl√∫ster                      |
| kube_network_03 | worker1       | 10.17.4.24   | Ejecuci√≥n de aplicaciones                |
| kube_network_03 | worker2       | 10.17.4.25   | Ejecuci√≥n de aplicaciones                |
| kube_network_03 | worker3       | 10.17.4.26   | Ejecuci√≥n de aplicaciones                |
| kube_network_03 | storage1      | 10.17.4.27   | Almacenamiento                          |

### Red br0

| Red NAT | Nodo       | Direcci√≥n IP | Rol del Nodo                             |
| ------- | ---------- | ------------ |------------------------------------------|
| kube_network_01     | k8s-api-lb | 10.17.5.10   | HAProxy + Keepalived VIP                 |

## Detalles de Configuraci√≥n

- **Im√°genes Base**:

  - Fedora CoreOS: `/mnt/lv_data/organized_storage/images/fedora-coreos-40.20240906.3.0-qemu.x86_64.qcow2`
  - Rocky Linux: `/mnt/lv_data/organized_storage/images/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2`
  - Alma Linux: `/mnt/lv_data/organized_storage/images/AlmaLinux-9.4-x86_64.qcow2`
  - pfsense: `/var/lib/libvirt/images/pfsense_base.qcow2 /mnt/lv_data/organized_storage/images/pfsense_base.qcow2`
  - Flatcar Container Linux: `/mnt/lv_data/organized_storage/images/flatcar_production_qemu_image.img`

- **Red Gateway**:
  
  - kube_network_01: 10.17.5.1  
  - kube_network_02: 10.17.3.1
  - kube_network_03: 10.17.4.1

- **DNS**:

  - Primario: 10.17.3.11 (infra-cluster)
  - Secundario: 8.8.8.8

- **Zona Horaria**:

  - Europe/London

- **Clave SSH**:

  - Clave p√∫blica SSH incluida para acceso seguro a las VMs.

## Configuraci√≥n de Redes Virtuales

### Red nat_network_01

```hcl
resource "libvirt_network" "Kube_network_01" {
  name      = var.rocky9_network_name
  mode      = "nat"
  autostart = true
  addresses = ["10.17.5.0/24"]
}
```

### Red kube_network_02 - NAT Network

```hcl
resource "libvirt_network" "kube_network_02" {
  name      = "kube_network_02"
  mode      = "nat"
  autostart = true
  addresses = ["10.17.3.0/24"]
}
```

### Red kube_network_03 - NAT Network

```hcl
resource "libvirt_network" "kube_network_03" {
  name      = "kube_network_03"
  mode      = "nat"
  autostart = true
  addresses = ["10.17.4.0/24"]
}
```

## Configuraci√≥n de Redes Virtuales

- **Switch**: TP-Link LS1008G - 8 puertos Gigabit no administrados
- **Router WiFi**: Conexi√≥n fibra √≥ptica, 600 Mbps de subida/bajada, IP p√∫blica
- **Red**: Configurada red NAT y red Bridge de kvm
- **VPN**: WireGuard para acceso seguro SSH administrado por Bastion Node

## Chronyc / NTP

- **Sincronizaci√≥n de tiempo**:
  Todos los nodos del cl√∫ster, incluyendo los nodos maestros, workers y el Bootstrap Node, sincronizan su tiempo utilizando **chronyc**. Esto garantiza que todos los nodos mantengan una sincronizaci√≥n temporal precisa, lo cual es crucial para la operaci√≥n correcta de Kubernetes y otros servicios distribuidos.

# Recursos de Automatizaci√≥n

| Proyecto                     | Repositorio                                                                                                                              |
| ---------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| CoreDNS                      | [https://github.com/vhgalvez/ansible-CoreDNS-setup-Linux](https://github.com/vhgalvez/ansible-CoreDNS-setup-Linux)                       |
| NTP / Chrony                 | [https://github.com/vhgalvez/ansible-ntp-chrony-kubernetes](https://github.com/vhgalvez/ansible-ntp-chrony-kubernetes)                   |
| HAProxy + Keepalived         | [https://github.com/vhgalvez/ansible-haproxy-keepalived](https://github.com/vhgalvez/ansible-haproxy-keepalived)                         |
| K3s HA (etcd)                | [https://github.com/vhgalvez/ansible-k3s-etcd-cluster](https://github.com/vhgalvez/ansible-k3s-etcd-cluster)                             |
| Traefik Ingress Controller   | [https://github.com/vhgalvez/traefik-k8s-ingress-controller-ansible](https://github.com/vhgalvez/traefik-k8s-ingress-controller-ansible) |
| Storage NFS + Longhorn       | [https://github.com/vhgalvez/flatcar-k3s-storage-suite](https://github.com/vhgalvez/flatcar-k3s-storage-suite)                           |
| Stack de Monitoreo           | [https://github.com/vhgalvez/ansible-monitoring-stack](https://github.com/vhgalvez/ansible-monitoring-stack)                             |
| Generar Clave SSH Compartida | [https://github.com/vhgalvez/generate_shared_ssh_key](https://github.com/vhgalvez/generate_shared_ssh_key)                               |
| Jenkins CI/CD                | [https://github.com/vhgalvez/jenkins-ansible-playbook](https://github.com/vhgalvez/jenkins-ansible-playbook)                             |
| ArgoCD                       | [https://github.com/vhgalvez/ArgoCD-ansible-kubernetes](https://github.com/vhgalvez/ArgoCD-ansible-kubernetes)                           |


# Arquitectura de Infraestructura Global

```bash

                         ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë  Infraestructura Global  ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë

                          [Usuarios P√∫blicos]
                                  ‚îÇ
                      (Acceso HTTPS - Seguridad - Cache)
                                  ‚îÇ
                                  ‚ñº
                          +-------------------+
                          |  Cloudflare CDN   | ‚óÑ‚îÄ‚îÄ Proxy + WAF + Anti-DDoS
                          |  (example.com)     |
                          +-------------------+
                                  ‚îÇ
                                  ‚ñº
                      +----------------------------+
                      | VPS (IP p√∫blica)           |
                      | WireGuard VPN Gateway      |
                      | IP T√∫nel: 10.17.0.1        |
                      +----------------------------+
                                  ‚îÇ
                                  ‚ñº
                     +-----------------------------+
                     | WireGuard Server (F√≠sico)   |
                     | Red LAN: 192.168.0.0/24     |
                     +-----------------------------+
                                  ‚îÇ
                                  ‚ñº
                     +-----------------------------+
                     |  servidor fisico nftables   |
                     |  IP: 192.168.0.19           |
                     |  NAT, VPN,                  |
                     +-----------------------------+
                                  ‚îÇ
                      (Redirecci√≥n de tr√°fico interno)
                                  ‚ñº
     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     ‚îÇ                          Kubernetes Ingress                          ‚îÇ
     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                 ‚îÇ
         ‚ñº                                 ‚ñº
+-------------------------+     +-------------------------+
| Load Balancer 1 (Traefik)|     | Load Balancer 2 (Traefik)|
| IP: 10.17.3.12           |     | IP: 10.17.3.13           |
+-------------------------+     +-------------------------+
         ‚îÇ                                 ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚ñº
          +---------------------------------------------+
          |  HAProxy + Keepalived (VIP: 10.17.5.10)     |
          |  Balanceo de Kubernetes API + Alta Disp.    |
          |  k8s-api-lb  ip mv: 10.17.5.20              |
          +---------------------------------------------+
                       ‚îÇ
                       ‚ñº
       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                   Kubernetes Control Plane             ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ               ‚îÇ                 ‚îÇ
        ‚ñº               ‚ñº                 ‚ñº
+----------------+ +----------------+ +----------------+
| Master Node 1  | | Master Node 2  | | Master Node 3  |
| 10.17.4.21     | | 10.17.4.22     | | 10.17.4.23     |
| (etcd, API)    | | (etcd)         | | (etcd)         |
+----------------+ +----------------+ +----------------+

       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ                Kubernetes Worker Nodes                       ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ               ‚îÇ                 ‚îÇ                 ‚îÇ
        ‚ñº               ‚ñº                 ‚ñº                 ‚ñº
+----------------+ +----------------+ +----------------+ +----------------+
| Worker Node 1  | | Worker Node 2  | | Worker Node 3  | | Storage Node   |
| 10.17.4.24     | | 10.17.4.25     | | 10.17.4.26     | | 10.17.4.27     |
|  Longhorn      | | Longhorn       | |    Longhorn    | |  üêÇ Longhorn    |
|               | |                | |                 | |  üìÅ NFS Server  |
+----------------+ +----------------+ +----------------+ +----------------+

                          ‚¨á Vol√∫menes en storage1 ‚¨á

+---------------------------------------------+
| /srv/nfs/postgresql ‚Üí PostgreSQL DB         |
| /srv/nfs/shared      ‚Üí Datos compartidos    |
| /mnt/longhorn-disk   ‚Üí Vol√∫menes Longhorn   |
+---------------------------------------------+

                        ‚¨á Clientes de almacenamiento ‚¨á

üîó NFS Mounts:
- PostgreSQL Node ‚Üí /srv/nfs/postgresql
- Pods con PVC RWX ‚Üí /srv/nfs/shared
- /mnt/longhorn-disk

üîó Longhorn PVCs:
- Prometheus, Grafana, ELK
- Todos los microservicios con almacenamiento distribuido (RWO)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üß† Roles Extra:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
+-------------------------+     +-------------------------+
| coredns (10.17.3.11)    |     | PostgreSQL (10.17.3.14)  |
| DNS + npt               |     | Base de datos central    |
+-------------------------+     +-------------------------+
```

* NFS s√≥lo gestiona PostgreSQL y datos compartidos (/srv/nfs/postgresql, /srv/nfs/shared)

* Longhorn gestiona todo lo dem√°s (monitoring + apps) desde /mnt/longhorn-disk

* storage1 est√° configurado con vol√∫menes LVM para aislar el espacio y prevenir desbordes

* La infraestructura est√° protegida por VPN (WireGuard), nftables y expuesta con seguridad v√≠a Cloudflare

## Arquitectura de Kubernetes (Cluster K3s)

![Cluster K3s](additional_resources/image/cluster_k3s.jpg)

## Homelab Server (Servidor F√≠sico ProLiant DL380 G7)

![Virtualizacion KVM](additional_resources/image/virtualizacion_kvm.jpg)

![Servidor en Rack](additional_resources/image/servidor_rack_01.jpg)

![Servidor en Rack](additional_resources/image/servidor_rack_02.jpg)

## Arquitectura de Red (Router fibra optica y Switch TP-Link LS1008G)

![Switch TP-Link LS1008G](additional_resources/image/switch-tplink-ls1008g.jpg)

## Interfaz Web de Administraci√≥n (Cockpit en Rocky Linux)

![Cockpit en Rocky Linux - Login](additional_resources/image/cockpit-rocky-linux-dashboard-login.png)

![Cockpit en Rocky Linux - Login](additional_resources/image/cockpit-rocky-linux-dashboard-metrics.png)

Pantalla de inicio de sesi√≥n de **Cockpit**, una interfaz web para administrar servidores **Rocky Linux** de forma remota y gr√°fica. Permite monitorear el sistema, gestionar servicios, redes, usuarios y acceder a una terminal sin depender exclusivamente de la l√≠nea de comandos.

## Longhorn instalado en el cl√∫ster K3s 

![alt text](additional_resources/image/k3s_ansible_Longhorn_02.png)

![alt text](additional_resources/image/k3s_ansible_Longhorn.png)


## Optimizaci√≥n para Producci√≥n

| Aspecto                     | Detalle                                                                                            |
| --------------------------- | -------------------------------------------------------------------------------------------------- |
| Restricci√≥n de Recursos     | Configura l√≠mites en Kubernetes para cada servicio (Prometheus, PostgreSQL, Redpanda, Redis).         |
| Control de Logs y Monitoreo | Define pol√≠ticas de retenci√≥n de logs en Prometheus y Kafka para reducir el consumo de disco.      |
| Supervisi√≥n Activa          | Usa Grafana para monitoreo en tiempo real, ajustando recursos seg√∫n los picos de carga detectados. |

Estas optimizaciones aseguran un entorno escalable y eficiente para producci√≥n.

## Interfaz de Red

| Interfaz     |
| ------------ |
| **enp3s0f0** |
| **enp3s0f1** |
| **enp4s0f0** |
| **enp4s0f1** |
| **lo**       |

Estas interfaces est√°n conectadas a un switch y un router de fibra √≥ptica, operando bajo DHCP y facilitando la conectividad y administraci√≥n del cl√∫ster.

## Resumen del Flujo

1. **Ingreso de Conexiones Externas**: Las conexiones HTTPS externas ingresan por la **IP p√∫blica (192.168.0.21)**.
2. **Acceso Seguro**: El tr√°fico pasa por el **Bastion Node (192.168.0.20)** para acceder de manera segura a la red interna.
3. **Distribuci√≥n de Tr√°fico**: El **Load Balancer1 Load Balancer2 (Traefik)** distribuye el tr√°fico hacia los nodos maestros y workers.
4. **Resoluci√≥n de Nombres y Sincronizaci√≥n de Tiempo**: **infra-cluster** act√∫a como servidor DNS y NTP, asegurando la resoluci√≥n de nombres y la sincronizaci√≥n temporal en todo el cl√∫ster.
5. **Ejecuci√≥n de Aplicaciones**: Los **nodos workers** **nodos master** ejecutan las aplicaciones, manteniendo la sincronizaci√≥n temporal a trav√©s de **chronyc**.

## üåê Configuraci√≥n de Redes Virtuales con pfSense

![pfSense](additional_resources/image/pfSense.jpg)

Esta secci√≥n te gu√≠a en la configuraci√≥n de redes virtuales utilizando **pfSense como firewall** dentro de tu infraestructura KVM. Aprovecha el proyecto automatizado con Terraform para desplegar pfSense r√°pidamente como una m√°quina virtual lista para enrutar tr√°fico entre redes virtualizadas.

---

### üîó Repositorio Oficial

Accede al c√≥digo fuente y plantillas de Terraform en el siguiente repositorio:

[üì¶ GitHub ‚Äì terraform-pfsense-kvm-libvirt](https://github.com/vhgalvez/terraform-pfsense-kvm-libvirt)

---

### üöÄ Clona el repositorio

Para comenzar con la configuraci√≥n:

```bash
git clone https://github.com/vhgalvez/terraform-pfsense-kvm-libvirt.git
cd terraform-pfsense-kvm-libvirt
```

---

## üîß Recursos Adicionales Soportados por HP ‚Äì Firmware ProLiant DL380 G7

Consulta y descarga actualizaciones oficiales de firmware y software para tu servidor HP desde el portal de soporte de Hewlett Packard Enterprise:

- [üîó Firmware HP ProLiant DL380 G7 ‚Äì P√°gina oficial de soporte](https://support.hpe.com/connect/s/softwaredetails?collectionId=MTX-5db24d8d46d14448&language=en_US&tab=releaseNotes)

## üíø Im√°genes de Disco para VMs

## ‚úÖ Flatcar para KVM/Libvirt: Descarga y preparaci√≥n

### üîΩ 1. Descargar imagen comprimida
```bash
sudo curl -O https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2
```

### üîê 2. (Opcional) Verificar firma
```bash
sudo curl -O https://www.flatcar.org/security/image-signing-key/Flatcar_Image_Signing_Key.asc
gpg --import Flatcar_Image_Signing_Key.asc
sudo curl -O https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2.sig
gpg --verify flatcar_production_qemu_image.img.bz2.sig flatcar_production_qemu_image.img.bz2
```

### üì¶ 3. Descomprimir imagen

```bash
bunzip2 flatcar_production_qemu_image.img.bz2
```

Resultado:

```bash
flatcar_production_qemu_image.img
```

> Lista para usar con Terraform, libvirt o virt-manager.

### üêß AlmaLinux 9.5 Generic Cloud (QCOW2)

```bash
curl -o alma9-generic.qcow2 https://repo.almalinux.org/almalinux/9.5/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2
```

---

## üì¶ Repositorio del Script SSH Compartido

Este repositorio utiliza un script externo para la generaci√≥n centralizada de claves SSH compartidas para todas las VMs del cl√∫ster.

üîó Repositorio: [generate_shared_ssh_key](https://github.com/vhgalvez/generate_shared_ssh_key.git)

Puedes clonarlo directamente con:

```bash
git clone https://github.com/vhgalvez/generate_shared_ssh_key.git
```

Este script es √∫til si est√°s automatizando la creaci√≥n de m√°quinas virtuales con Terraform y necesitas una clave reutilizable para conectarte v√≠a SSH con Flatcar.
