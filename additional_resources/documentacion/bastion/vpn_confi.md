




sudo git clone https://github.com/wg-easy/wg-easy.git



docker-compose.yml
services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wg-easy
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    privileged: true
    environment:
      - LANG=es
      - PASSWORD_HASH=$$2a$$12$$2S/MKBOSBAvoVfF4Og02iOaRIzvcHD1NOGG.M2nWAhG9GsgMlz71m
      - WG_DEFAULT_DNS=1.1.1.1
      - WG_HOST=192.168.0.18
      - WG_PORT=51820
    ports:
      - 51820:51820/udp
      - 51821:51821/tcp
    restart: unless-stopped
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    volumes:
      - ./wireguard:/etc/wireguard



sudo iptables -t nat -L -v
sudo iptables -L -v




```bash
sudo setenforce 0
sudo systemctl restart libvirtd
sudo systemctl restart iptables
sudo systemctl status iptables

sudo modprobe nft_nat
sudo modprobe nf_nat
sudo modprobe ip_tables
```


```bash
cat /home/$USER/vpn-Wireguard/wg-easy/wireguard/wg0.conf
```



```ini
# Note: Do not edit this file directly.
# Your changes will be overwritten!

# Server
[Interface]
PrivateKey = 4AQxRkI8XjOX3tiNJBebJjjQERqUhbbX1XAoKqMxGmw=
Address = 10.8.0.1/24
ListenPort = 51820
PreUp =
PostUp =  iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE; iptables -A INPUT -p udp -m udp --dport 51820 -j ACCEPT; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT;
PreDown =
PostDown =  iptables -t nat -D POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE; iptables -D INPUT -p udp -m udp --dport 51820 -j ACCEPT; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT;


# Client: windows (2c0fdeae-0f46-4dde-afbc-31e52130c1c7)
[Peer]
PublicKey = dbTu+o8/aAcEpUfLiXFPLKTrHtsgnaaUvSu0iSeRwTA=
PresharedKey = dB/i8HbRhxbVgat+cCuiyXxxXb+vrkoPAZdwLpU1RCc=
AllowedIPs = 10.8.0.2/32[victory@physical1 wireguard]$
```


Cliente Windows

```bash

client.conf

```ini
[Interface]
PrivateKey = 4LgWUrp6hcZi/CL8wAmOOAqfgX4OyNA9IBvNalrdi0Y=
Address = 10.8.0.2/24
DNS = 192.168.0.18, 1.1.1.1 

[Peer]
PublicKey = FYYTGsLP1lAF3Ku04/IM41BImhmXnqZqbJTLIMrMgwA=
PresharedKey = dB/i8HbRhxbVgat+cCuiyXxxXb+vrkoPAZdwLpU1RCc=
AllowedIPs = 10.8.0.0/24, 192.168.0.0/24, 10.89.0.0/24, 10.17.3.0/24, 10.17.4.0/24
PersistentKeepalive = 25
Endpoint = 192.168.0.18:51820
```


[victory@physical1 ~]$ sudo systemctl status iptables
● iptables.service - IPv4 firewall with iptables
     Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled; preset: disabled)
     Active: active (exited) since Tue 2024-12-03 13:05:59 CET; 43min ago
    Process: 32965 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
   Main PID: 32965 (code=exited, status=0/SUCCESS)
        CPU: 24ms

dic 03 13:05:59 physical1.cefaslocalserver.com systemd[1]: Starting IPv4 firewall with iptables...
dic 03 13:05:59 physical1.cefaslocalserver.com iptables.init[32965]: iptables: Applying firewall rules: [  OK  ]
dic 03 13:05:59 physical1.cefaslocalserver.com systemd[1]: Finished IPv4 firewall with iptables.
[victory@physical1 ~]$ cat /usr/lib/systemd/system/iptables.service
[Unit]
Description=IPv4 firewall with iptables
AssertPathExists=/etc/sysconfig/iptables
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/libexec/iptables/iptables.init start
ExecReload=/usr/libexec/iptables/iptables.init reload
ExecStop=/usr/libexec/iptables/iptables.init stop
Environment=BOOTUP=serial
Environment=CONSOLETYPE=serial

[Install]
WantedBy=multi-user.target
[victory@physical1 ~]$ cat /etc/sysconfig/iptables
*filter
# Políticas predeterminadas para las cadenas INPUT, FORWARD y OUTPUT
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Permitir tráfico VPN
-A INPUT -p udp --dport 51820 -j ACCEPT
-A FORWARD -i wg0 -j ACCEPT
-A FORWARD -o wg0 -j ACCEPT

# Permitir tráfico entre LAN, NAT y VPN
-A FORWARD -s 10.8.0.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 10.8.0.0/24 -d 10.17.3.0/24 -j ACCEPT
-A FORWARD -s 10.8.0.0/24 -d 10.17.4.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.8.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.3.0/24 -d 10.8.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.4.0/24 -d 10.8.0.0/24 -j ACCEPT

# Asegurar que el tráfico entre las redes NAT y LAN esté permitido
-A FORWARD -s 10.17.3.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.4.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.17.3.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.17.4.0/24 -j ACCEPT

COMMIT

*nat
# Políticas predeterminadas para las cadenas NAT
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# NAT para VPN
-A POSTROUTING -s 10.8.0.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr1 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr2 -j MASQUERADE

# NAT para LAN y NAT
-A POSTROUTING -s 192.168.0.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.17.3.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.17.4.0/24 -o br0 -j MASQUERADE

COMMIT
