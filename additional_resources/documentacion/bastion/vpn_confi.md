sudo git clone https://github.com/wg-easy/wg-easy.git

sudo docker run --rm -it ghcr.io/wg-easy/wg-easy wgpw '123456'


docker-compose.yml
services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wg-easy
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    privileged: true
    environment:
      - LANG=es
      - PASSWORD_HASH=$$2a$$12$$2S/MKBOSBAvoVfF4Og02iOaRIzvcHD1NOGG.M2nWAhG9GsgMlz71m
      - WG_DEFAULT_DNS=1.1.1.1
      - WG_HOST=192.168.0.18
      - WG_PORT=51820
    ports:
      - 51820:51820/udp
      - 51821:51821/tcp
    restart: unless-stopped
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    volumes:
      - ./wireguard:/etc/wireguard


sudo docker-compose up -d


sudo iptables -t nat -L -v
sudo iptables -L -v




```bash
sudo setenforce 0
sudo systemctl restart libvirtd
sudo systemctl restart iptables
sudo systemctl status iptables

sudo modprobe nft_nat
sudo modprobe nf_nat
sudo modprobe ip_tables
```


```bash
cat /home/$USER/vpn-Wireguard/wg-easy/wireguard/wg0.conf
```



```ini
# Note: Do not edit this file directly.
# Your changes will be overwritten!

# Server
[Interface]
PrivateKey = 4AQxRkI8XjOX3tiNJBebJjjQERqUhbbX1XAoKqMxGmw=
Address = 10.8.0.1/24
ListenPort = 51820
PreUp =
PostUp =  iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE; iptables -A INPUT -p udp -m udp --dport 51820 -j ACCEPT; iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT;
PreDown =
PostDown =  iptables -t nat -D POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE; iptables -D INPUT -p udp -m udp --dport 51820 -j ACCEPT; iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT;


# Client: windows (2c0fdeae-0f46-4dde-afbc-31e52130c1c7)
[Peer]
PublicKey = dbTu+o8/aAcEpUfLiXFPLKTrHtsgnaaUvSu0iSeRwTA=
PresharedKey = dB/i8HbRhxbVgat+cCuiyXxxXb+vrkoPAZdwLpU1RCc=
AllowedIPs = 10.8.0.2/32[victory@physical1 wireguard]$
```


Cliente Windows

```bash

client.conf

```ini
[Interface]
PrivateKey = 4LgWUrp6hcZi/CL8wAmOOAqfgX4OyNA9IBvNalrdi0Y=
Address = 10.8.0.2/24
DNS = 192.168.0.18, 1.1.1.1 

[Peer]
PublicKey = FYYTGsLP1lAF3Ku04/IM41BImhmXnqZqbJTLIMrMgwA=
PresharedKey = dB/i8HbRhxbVgat+cCuiyXxxXb+vrkoPAZdwLpU1RCc=
AllowedIPs = 10.8.0.0/24, 192.168.0.0/24, 10.89.0.0/24, 10.17.3.0/24, 10.17.4.0/24
PersistentKeepalive = 25
Endpoint = 192.168.0.18:51820
```


[victory@physical1 ~]$ sudo systemctl status iptables
● iptables.service - IPv4 firewall with iptables
     Loaded: loaded (/usr/lib/systemd/system/iptables.service; enabled; preset: disabled)
     Active: active (exited) since Tue 2024-12-03 13:05:59 CET; 43min ago
    Process: 32965 ExecStart=/usr/libexec/iptables/iptables.init start (code=exited, status=0/SUCCESS)
   Main PID: 32965 (code=exited, status=0/SUCCESS)
        CPU: 24ms

dic 03 13:05:59 physical1.cefaslocalserver.com systemd[1]: Starting IPv4 firewall with iptables...
dic 03 13:05:59 physical1.cefaslocalserver.com iptables.init[32965]: iptables: Applying firewall rules: [  OK  ]
dic 03 13:05:59 physical1.cefaslocalserver.com systemd[1]: Finished IPv4 firewall with iptables.
[victory@physical1 ~]$ cat /usr/lib/systemd/system/iptables.service
[Unit]
Description=IPv4 firewall with iptables
AssertPathExists=/etc/sysconfig/iptables
Before=network-pre.target
Wants=network-pre.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/usr/libexec/iptables/iptables.init start
ExecReload=/usr/libexec/iptables/iptables.init reload
ExecStop=/usr/libexec/iptables/iptables.init stop
Environment=BOOTUP=serial
Environment=CONSOLETYPE=serial

[Install]
WantedBy=multi-user.target
[victory@physical1 ~]$ cat /etc/sysconfig/iptables
*filter
# Políticas predeterminadas para las cadenas INPUT, FORWARD y OUTPUT
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Permitir tráfico VPN
-A INPUT -p udp --dport 51820 -j ACCEPT
-A FORWARD -i wg0 -j ACCEPT
-A FORWARD -o wg0 -j ACCEPT

# Permitir tráfico entre LAN, NAT y VPN
-A FORWARD -s 10.8.0.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 10.8.0.0/24 -d 10.17.3.0/24 -j ACCEPT
-A FORWARD -s 10.8.0.0/24 -d 10.17.4.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.8.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.3.0/24 -d 10.8.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.4.0/24 -d 10.8.0.0/24 -j ACCEPT

# Asegurar que el tráfico entre las redes NAT y LAN esté permitido
-A FORWARD -s 10.17.3.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 10.17.4.0/24 -d 192.168.0.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.17.3.0/24 -j ACCEPT
-A FORWARD -s 192.168.0.0/24 -d 10.17.4.0/24 -j ACCEPT

COMMIT

*nat
# Políticas predeterminadas para las cadenas NAT
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# NAT para VPN
-A POSTROUTING -s 10.8.0.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr0 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr1 -j MASQUERADE
-A POSTROUTING -s 10.8.0.0/24 -o virbr2 -j MASQUERADE

# NAT para LAN y NAT
-A POSTROUTING -s 192.168.0.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.17.3.0/24 -o br0 -j MASQUERADE
-A POSTROUTING -s 10.17.4.0/24 -o br0 -j MASQUERADE

COMMIT


[victory@physical1 ~]$ ip route
default via 192.168.0.1 dev enp4s0f0 proto dhcp src 192.168.0.18 metric 101
default via 192.168.0.1 dev enp3s0f1 proto dhcp src 192.168.0.21 metric 102
default via 192.168.0.1 dev enp4s0f1 proto dhcp src 192.168.0.16 metric 103
default via 192.168.0.1 dev br0 proto dhcp src 192.168.0.24 metric 425
10.17.3.0/24 dev virbr1 proto kernel scope link src 10.17.3.1 linkdown
10.17.4.0/24 dev virbr2 proto kernel scope link src 10.17.4.1 linkdown
10.89.0.0/24 dev podman1 proto kernel scope link src 10.89.0.1
192.168.0.0/24 dev enp4s0f0 proto kernel scope link src 192.168.0.18 metric 101
192.168.0.0/24 dev enp3s0f1 proto kernel scope link src 192.168.0.21 metric 102
192.168.0.0/24 dev enp4s0f1 proto kernel scope link src 192.168.0.16 metric 103
192.168.0.0/24 dev br0 proto kernel scope link src 192.168.0.24 metric 425
192.168.122.0/24 dev virbr0 proto kernel scope link src 192.168.122.1 linkdown
[victory@physical1 ~]$


(base) PS C:\Users\vhgal> route print
===========================================================================
ILista de interfaces
 84...........................WireGuard Tunnel
 23...74 56 3c 6e a7 13 ......Realtek Gaming 2.5GbE Family Controller
  4...0a 00 27 00 00 04 ......VirtualBox Host-Only Ethernet Adapter
 18...00 ff a1 95 4a 5a ......Phantom TAP-Windows Adapter V9
 10...48 22 54 1c 64 4b ......TP-Link Wireless USB Adapter
 21...4a 22 54 1c 64 4b ......Microsoft Wi-Fi Direct Virtual Adapter
  2...48 22 54 1c 64 4b ......Microsoft Wi-Fi Direct Virtual Adapter #2
  1...........................Software Loopback Interface 1
 32...00 15 5d bc 57 c0 ......Hyper-V Virtual Ethernet Adapter
 89...00 15 5d 6a bd 0b ......Hyper-V Virtual Ethernet Adapter #2
===========================================================================

IPv4 Tabla de enrutamiento
===========================================================================
Rutas activas:
Destino de red        Máscara de red   Puerta de enlace   Interfaz  Métrica
          0.0.0.0          0.0.0.0      192.168.0.1     192.168.0.13     25
          0.0.0.0          0.0.0.0      En vínculo          10.8.0.2      0
         10.8.0.0    255.255.255.0      En vínculo          10.8.0.2    256
         10.8.0.2  255.255.255.255      En vínculo          10.8.0.2    256
       10.8.0.255  255.255.255.255      En vínculo          10.8.0.2    256
        127.0.0.0        255.0.0.0      En vínculo         127.0.0.1    331
        127.0.0.1  255.255.255.255      En vínculo         127.0.0.1    331
  127.255.255.255  255.255.255.255      En vínculo         127.0.0.1    331
      169.254.0.0      255.255.0.0      En vínculo     169.254.240.2    281
    169.254.240.2  255.255.255.255      En vínculo     169.254.240.2    281
  169.254.255.255  255.255.255.255      En vínculo     169.254.240.2    281
      172.25.80.0    255.255.240.0      En vínculo       172.25.80.1   5256
      172.25.80.1  255.255.255.255      En vínculo       172.25.80.1   5256
    172.25.95.255  255.255.255.255      En vínculo       172.25.80.1   5256
      192.168.0.0    255.255.255.0      En vínculo      192.168.0.13    281
      192.168.0.0    255.255.255.0         10.8.0.1         10.8.0.2      1
     192.168.0.13  255.255.255.255      En vínculo      192.168.0.13    281
    192.168.0.255  255.255.255.255      En vínculo      192.168.0.13    281
    192.168.240.0    255.255.240.0      En vínculo     192.168.240.1   5256
    192.168.240.1  255.255.255.255      En vínculo     192.168.240.1   5256
  192.168.255.255  255.255.255.255      En vínculo     192.168.240.1   5256
        224.0.0.0        240.0.0.0      En vínculo         127.0.0.1    331
        224.0.0.0        240.0.0.0      En vínculo     169.254.240.2    281
        224.0.0.0        240.0.0.0      En vínculo      192.168.0.13    281
        224.0.0.0        240.0.0.0      En vínculo     192.168.240.1   5256
        224.0.0.0        240.0.0.0      En vínculo       172.25.80.1   5256
  255.255.255.255  255.255.255.255      En vínculo         127.0.0.1    331
  255.255.255.255  255.255.255.255      En vínculo     169.254.240.2    281
  255.255.255.255  255.255.255.255      En vínculo      192.168.0.13    281
  255.255.255.255  255.255.255.255      En vínculo     192.168.240.1   5256
  255.255.255.255  255.255.255.255      En vínculo       172.25.80.1   5256
===========================================================================
Rutas persistentes:
  Dirección de red  Máscara de red  Dirección de puerta de enlace  Métrica
      192.168.0.0    255.255.255.0         10.8.0.1       1
===========================================================================

IPv6 Tabla de enrutamiento
===========================================================================
Rutas activas:
 Cuando destino de red métrica      Puerta de enlace
 84      0 ::/0                     En vínculo
  1    331 ::1/128                  En vínculo
  4    281 fe80::/64                En vínculo
 23    281 fe80::/64                En vínculo
 32   5256 fe80::/64                En vínculo
 89   5256 fe80::/64                En vínculo
  4    281 fe80::56b:1a34:9012:e0fb/128
                                    En vínculo
 23    281 fe80::21f4:8d4:b255:da12/128
                                    En vínculo
 32   5256 fe80::2b00:8e59:980d:f8a0/128
                                    En vínculo
 89   5256 fe80::60e0:c127:4342:eb64/128
                                    En vínculo
  1    331 ff00::/8                 En vínculo
  4    281 ff00::/8                 En vínculo
 23    281 ff00::/8                 En vínculo
 32   5256 ff00::/8                 En vínculo
 89   5256 ff00::/8                 En vínculo
===========================================================================
Rutas persistentes:
  Ninguno
(base) PS C:\Users\vhgal>



__


core@master1 ~ $ ip route
default via 10.17.4.1 dev eth0 proto static
10.17.3.0/24 via 10.17.4.1 dev eth0
10.17.4.0/24 dev eth0 proto kernel scope link src 10.17.4.21
core@master1 ~ $

[core@freeipa1 ~]$ ip route
default via 10.17.3.1 dev eth0 proto dhcp src 10.17.3.11 metric 100
10.17.3.0/24 dev eth0 proto kernel scope link src 10.17.3.11 metric 100
10.17.4.0/24 via 10.17.3.1 dev eth0
192.168.0.0/24 via 10.17.3.1 dev eth0
[core@freeipa1 ~]$

sudo ip route add 10.17.3.0/24 via 10.17.4.1 dev eth0


# Server fisico

vpn-Wireguard

sudo ip route add 10.8.0.0/24 via 192.168.0.1 dev enp4s0f0


ping -c 4 192.168.0.20
ping -c 4 192.168.0.1

ping -c 4 10.17.3.11
ping -c 4 10.17.3.1

ping -c 4 10.17.4.21
ping -c 4 10.17.4.1
ping -c 4 8.8.8.8
ping -c 4 google.com

ip route show
ip a

hostnamectl
hostname -f

traceroute 8.8.8.8
traceroute 10.17.3.1
traceroute 10.17.3.11
traceroute 10.17.4.21
traceroute 10.17.4.1
traceroute 192.168.0.20
traceroute 192.168.0.1

hostname -I

cat /etc/resolv.conf

ping -c 4 10.17.3.1
ping -c 4 10.17.3.11 
ping -c 4 10.17.4.1 

ping -c 4 10.17.4.21
ping -c 4 192.168.0.20
ping -c 4 192.168.0.1  
ping -c 4 8.8.8.8
ping -c 4 google.com


ip route show
ip addr show eth0



sudo systemctl restart libvirtd

sudo setenforce 0
sudo systemctl restart libvirtd
sudo systemctl restart NetworkManager
sudo systemctl restart nftables


sudo systemctl enable nftables
sudo systemctl start nftables
sudo systemctl status nftables




sudo nft flush ruleset
sudo nft -f /etc/sysconfig/nftables.conf
sudo systemctl restart nftables
sudo nft list ruleset


sudo nft flush ruleset
sudo iptables -F
sudo iptables -t nat -F
sudo ip6tables -F
sudo ip6tables -t nat -F


sudo nft flush ruleset
sudo nft list tables | grep -oP "(?<=table )\S+" | xargs -I {} sudo nft delete table {}


# master1
sudo ip route add default via 10.17.4.1 dev eth0
sudo ip route add default via 10.17.4.1 dev eth0
sudo ip route add 10.8.0.0/24 via 10.17.4.1 dev eth0

# master1
sudo ip route add 10.17.3.0/24 via 10.17.4.1 dev eth0
sudo ip route add 10.17.3.0/24 via 10.17.4.1 dev eth0

sudo ip addr add 10.17.3.21/24 dev eth0
sudo ip link set eth0 up


sudo ip route add 10.17.3.0/24 via 10.17.4.1 dev eth0
sudo ip route add 192.168.0.0/24 via 10.17.4.1 dev eth0

# freeipa1
sudo ip addr add 10.17.4.21/24 dev eth0
sudo ip link set eth0 up

# Ruta por defecto
sudo ip route add default via 10.17.3.1 dev eth0

# Ruta a la red 10.17.3.0/24
sudo ip route add 10.17.3.0/24 dev eth0

# Ruta a la red 10.17.4.0/24 a través de 10.17.3.1
sudo ip route add 10.17.4.0/24 via 10.17.3.1 dev eth0

# Ruta a la red 192.168.0.0/24 a través de 10.17.3.1
sudo ip route add 192.168.0.0/24 via 10.17.3.1 dev eth0




# Comandos IP Route por Nodo Version de Desarrollo

# master1

```bash
sudo ip route add 10.17.3.0/24 via 10.17.4.1 dev eth0
sudo ip route add 192.168.0.0/24 via 10.17.3.1 dev eth0
```

# bastion1

```bash
sudo ip route add 10.17.3.0/24 via 192.168.0.18 dev eth0
sudo ip route add 10.17.4.0/24 via 192.168.0.18 dev eth0
```
# freeipa1

```bash
sudo ip route add 10.17.4.0/24 via 10.17.3.1 dev eth0
sudo ip route add 192.168.0.0/24 via 10.17.3.1 dev eth0
```



sudo iptables -A FORWARD -i wg0 -o br0 -j ACCEPT
sudo iptables -A FORWARD -i br0 -o wg0 -j ACCEPT
