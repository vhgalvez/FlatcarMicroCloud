#!/usr/sbin/nft -f

flush ruleset

# ğŸ”’ Tabla de filtrado principal
table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    # âœ… TrÃ¡fico seguro
    ct state established,related accept
    iif "lo" accept
    ip protocol icmp accept

    # âœ… Acceso explÃ­cito al nodo Load Balancer (VIP local)
    ip daddr 192.168.0.30 tcp dport { 80, 443, 8080, 8443 } accept

    # âœ… Puertos TCP globales permitidos
    tcp dport {
      22, 80, 443, 8080, 8443,
      3389, 6443, 8081, 8082,
      9090, 9091, 9093, 9100, 3000,
      32000, 32001, 32002, 32003, 32004
    } accept

    # âœ… Acceso al VIP del API Server
    ip daddr 10.17.5.10 tcp dport 6443 accept

    # âœ… NTP (UDP)
    udp dport 123 accept

    # âœ… TrÃ¡fico desde bridges y red LAN
    iifname { "virbr0", "br0", "virbr_kube02", "virbr_kube03" } accept
  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    # ğŸ”„ Sesiones existentes
    ct state established,related accept

    # âœ… ComunicaciÃ³n interna entre subredes del clÃºster
    ip saddr 10.17.0.0/16 ip daddr 10.17.0.0/16 accept

    # âœ… Bridges virtuales
    iifname { "virbr0", "br0", "virbr_kube02", "virbr_kube03" } accept
    oifname { "virbr0", "br0", "virbr_kube02", "virbr_kube03" } accept

    # âœ… Forward explÃ­cito al VIP del API Server
    ip daddr 10.17.5.10 tcp dport 6443 accept

    # âœ… TrÃ¡fico en interfaz fÃ­sica principal
    iifname "enp4s0f0" accept
    oifname "enp4s0f0" accept
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}

# ğŸ” Tabla de NAT para salida a Internet
table inet nat {
  chain postrouting {
    type nat hook postrouting priority 100; policy accept;

    # âœ… Masquerade desde redes internas
    ip saddr 10.17.3.0/24 oifname "enp4s0f0" masquerade
    ip saddr 10.17.4.0/24 oifname "enp4s0f0" masquerade
    ip saddr 192.168.0.0/24 oifname "enp4s0f0" masquerade
  }
}